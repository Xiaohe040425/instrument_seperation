<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轉換結果 - 流行樂轉管樂譜系統</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
</head>
<body>
    <!-- 頂部導航欄 -->
    <div class="navbar">
        <div class="navbar-title">
            <a href="{{ url_for('main.index') }}" style="color: white; text-decoration: none;">
                <i class="fas fa-arrow-left" style="margin-right: 10px;"></i>流行樂轉管樂譜系統
            </a>
        </div>
        <div class="navbar-controls">
            <button class="icon-button"><i class="fas fa-exclamation-triangle"></i></button>
            <button class="icon-button"><i class="fas fa-cog"></i></button>
            <button class="icon-button"><i class="fas fa-expand"></i></button>
        </div>
    </div>

    <!-- 主要內容 -->
    <div class="main-container" style="padding-top: 0;">
        <div class="result-layout">
            <!-- 左側：輸入檔案列表 -->
            <div class="file-list">
                <h3 class="section-title">輸入檔案</h3>
                <div id="input-files-container">
                    {% for file in input_files %}
                    <div class="file-item">{{ file.name }}</div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- 中間：轉換進度和控制 -->
            <div class="conversion-status">
                <div class="progress-container">
                    <h3 id="status-text">
                        {% if progress == 100 %}
                        轉換完成
                        {% elif progress > 0 %}
                        轉換中...
                        {% else %}
                        準備開始轉換
                        {% endif %}
                    </h3>
                    <div class="progress-bar">
                        <div id="progress" class="progress" style="width: {{ progress }}%"></div>
                    </div>
                    <p id="progress-text">{{ progress }}% 已完成</p>
                </div>
                
                <div style="text-align: center;">
                    {% if progress < 100 %}
                    <button id="start-convert-btn" class="btn">開始轉換</button>
                    {% else %}
                    <a href="{{ url_for('main.statistic_page', job_id=job_id, chart_type='breathing') }}" class="btn">分析圖表</a>
                    {% endif %}
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <img src="{{ url_for('static', filename='img/arrow.png') }}" alt="箭頭" style="width: 100px; height: auto;">
                </div>
            </div>
            
            <!-- 右側：輸出檔案列表 -->
            <div class="file-list">
                <h3 class="section-title">輸出檔案</h3>
                <div id="output-files-container">
                    {% for file in output_files %}
                    <div class="file-item">{{ file.name }}</div>
                    {% endfor %}
                </div>
                
                {% if output_files %}
                <div style="margin-top: 30px; text-align: center;">
                    <button id="download-btn" class="btn" onclick="downloadFiles('{{ job_id }}')">下載檔案</button>
                    <div id="download-status" style="margin-top: 10px; font-style: italic; color: #666;"></div>
                </div>
                {% endif %} 
            </div>
        </div>
    </div>

    <script>
    const jobId = "{{ job_id }}";
    let progress = {{ progress }};
    const startConvertBtn = document.getElementById('start-convert-btn');
    const progressElement = document.getElementById('progress');
    const progressTextElement = document.getElementById('progress-text');
    const statusTextElement = document.getElementById('status-text');
    
    console.log("Job ID:", jobId);
    console.log("Initial progress:", progress);
    console.log("Start button found:", !!startConvertBtn);
    
    // 下載函數 - 將此函數放在腳本的開始部分
    function downloadFiles(jobId) {
        const downloadBtn = document.getElementById('download-btn');
        const downloadStatus = document.getElementById('download-status');
        
        // 禁用按鈕並顯示準備狀態
        downloadBtn.disabled = true;
        downloadBtn.textContent = '準備下載中...';
        downloadStatus.textContent = '正在準備您的檔案...';
        downloadStatus.style.color = '#0066cc';
        
        // 創建隱藏的下載連結
        const downloadLink = document.createElement('a');
        downloadLink.href = '/download/' + jobId;
        downloadLink.style.display = 'none';
        document.body.appendChild(downloadLink);
        
        // 觸發下載
        downloadLink.click();
        
        // 模擬下載完成（因為無法直接檢測下載狀態，使用定時器）
        setTimeout(() => {
            downloadBtn.disabled = false;
            downloadBtn.textContent = '下載檔案';
            downloadStatus.textContent = '✓ 下載完成！請檢查您的下載資料夾。';
            downloadStatus.style.color = '#28a745';
            
            // 3秒後清除狀態訊息
            setTimeout(() => {
                downloadStatus.textContent = '';
            }, 3000);
            
            // 清理DOM
            document.body.removeChild(downloadLink);
        }, 2000); // 2秒後顯示下載完成
    }
    
    // 如果進度尚未完成，設置開始轉換按鈕事件
    if (progress < 100 && startConvertBtn) {
        console.log("Adding event listener to start button");
        
        startConvertBtn.addEventListener('click', function() {
            console.log("Start button clicked");
            
            // 禁用按鈕防止重複點擊
            this.disabled = true;
            this.textContent = '處理中...';
            
            // 發送轉換請求
            console.log("Sending request to:", '/api/convert/' + jobId);
            
            fetch('/api/convert/' + jobId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                console.log("Response status:", response.status);
                if (!response.ok) {
                    throw new Error('網路響應不正常: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log("API response:", data);
                if (data.status === 'success') {
                    console.log("Starting progress monitoring");
                    // 開始監控進度
                    startProgressMonitoring();
                } else {
                    console.error("Conversion failed:", data.message);
                    alert('轉換失敗：' + data.message);
                    this.disabled = false;
                    this.textContent = '開始轉換';
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert('發生錯誤：' + error);
                this.disabled = false;
                this.textContent = '開始轉換';
            });
        });
    } else {
        console.log("Not adding event listener. Progress:", progress, "Button found:", !!startConvertBtn);
    }
    
    // 如果進度已開始但尚未完成，自動開始監控進度
    if (progress > 0 && progress < 100) {
        console.log("Auto-starting progress monitoring");
        startProgressMonitoring();
    }
    
    // 監控進度函數
    function startProgressMonitoring() {
        statusTextElement.textContent = '轉換中...';
        
        const interval = setInterval(() => {
            console.log("Checking progress...");
            
            fetch('/api/status/' + jobId)
            .then(response => response.json())
            .then(data => {
                console.log("Progress data:", data);
                
                if (data.status === 'error') {
                    clearInterval(interval);
                    console.error("Error checking progress:", data.message);
                    statusTextElement.textContent = '轉換失敗';
                    
                    // 顯示具體錯誤信息
                    const errorMessage = data.message || '未知錯誤';
                    alert('轉換過程發生錯誤：' + errorMessage);
                    
                    // 重置按鈕狀態
                    if (startConvertBtn) {
                        startConvertBtn.disabled = false;
                        startConvertBtn.textContent = '重新開始轉換';
                    }
                    return;
                }
                
                // 更新進度
                progress = data.progress || 0;
                progressElement.style.width = progress + '%';
                progressTextElement.textContent = progress + '% 已完成';
                
                // 更新狀態文字（如果有階段資訊）
                if (data.stage) {
                    statusTextElement.textContent = data.stage;
                } else if (progress < 100) {
                    statusTextElement.textContent = '轉換中...';
                }
                
                // 如果完成，重新載入頁面顯示結果
                if (data.status === 'completed' || progress >= 100) {
                    console.log("Conversion completed, reloading page");
                    clearInterval(interval);
                    statusTextElement.textContent = '轉換完成！即將刷新頁面...';
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500); // 延遲1.5秒再重載，讓用戶看到完成狀態
                }
            })
            .catch(error => {
                console.error('監控進度時發生錯誤：', error);
                clearInterval(interval);
                statusTextElement.textContent = '監控進度時發生錯誤';
                alert('監控進度時發生錯誤：' + error.message);
                
                // 重置按鈕狀態
                if (startConvertBtn) {
                    startConvertBtn.disabled = false;
                    startConvertBtn.textContent = '重新開始轉換';
                }
            });
        }, 800); // 每0.8秒檢查一次進度
    }
</script>
</body>
</html>